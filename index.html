<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>chungo-bomber</title>
        <script src="phaser.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {
        var map = [0, 0, 0, 164, 0, 0, 0, 0, 164, 0, 0, 0, 0, 0, 164, 296, 234, 265, 327, 164, 0, 0, 0, 164, 0, 0, 0, 0, 164, 0, 0, 0, 0, 0, 164, 0, 0, 0, 0, 164, 0, 0, 0, 164, 0, 0, 0, 0, 164, 0, 0, 0, 0, 0, 164, 164, 0, 164, 164, 164, 0, 164, 164, 164, 0, 0, 0, 0, 164, 164, 164, 0, 0, 0, 164, 0, 0, 0, 0, 164, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 164, 0, 164, 164, 164, 164, 0, 164, 164, 164, 164, 164, 164, 164, 0, 164, 164, 164, 164, 164, 164, 0, 164, 0, 0, 0, 0, 164, 0, 164, 0, 0, 0, 0, 0, 0, 0, 0, 164, 0, 0, 0, 164, 0, 164, 164, 164, 164, 0, 0, 0, 0, 164, 0, 0, 0, 164, 0, 0, 0, 0, 0, 164, 0, 0, 0, 0, 164, 164, 164, 164, 164, 164, 164, 0, 164, 164, 164, 164, 164, 164, 0, 164, 164, 164, 0, 164, 164, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 164, 0, 164, 0, 0, 164, 0, 0, 164, 164, 164, 0, 0, 164, 164, 164, 0, 0, 0, 0, 0, 0, 164, 164, 0, 164, 0, 0, 0, 0, 164, 0, 0, 164, 0, 0, 0, 0, 0, 0, 164, 0, 164, 0, 0, 164, 0, 0, 0, 0, 164, 0, 0, 164, 0, 0, 0, 0, 0, 0, 164, 0, 164, 0, 0, 164, 0, 164, 0, 0, 0, 0, 0, 0, 0, 0, 0, 164, 0, 0, 164, 0, 164, 0, 164, 164, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 164, 0, 164, 0, 0, 164, 0, 164, 0, 164, 0, 0, 0, 0, 0, 164, 0, 164, 0, 0, 164, 0, 164, 0, 0, 164, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 164, 0, 164, 164, 0, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 0, 164, 0, 164, 0, 0, 164, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 164, 0, 0, 0, 0, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164];
        var prota_position = {x:0,y:1};
        var bomps = [];
        var fires = [];
        var mapfires = [];

        var bompstodelete = [];
        var firestodelete = [];

        var game = new Phaser.Game(2560, 2560, Phaser.AUTO, '', { preload: preload, create: create, update:update, rende:render });

        function preload () {

          game.load.image('logo', 'phaser.png');
          game.load.tilemap('map', null, generateTilemap(map), Phaser.Tilemap.TILED_JSON);
          game.load.image('building', 'sheet.png');
          game.load.image('bomp', 'bomp.png');
          game.load.image('sprites', 'spritesheet_complete.png');
          game.load.spritesheet('sprs', 'spritesheet_complete.png', 128, 256, -1, 2, 2);
          game.load.spritesheet('fire', 'fire.png', 128, 128);


        }
        var prota, protaTween;
        var upKey;
        var downKey;
        var leftKey;
        var rightKey;
        var spaceKey;
        var moving = false;
        function create () {
        //    game.physics.startSystem(Phaser.Physics.ARCADE);

            var map = game.add.tilemap('map');
            map.addTilesetImage('spritesheet_complete','sprites');
      //      map.addTilesetImage('building');
            prota = game.add.sprite(0, 0, "sprs");
            prota.y =128;
        //    prota.width = 128; prota.height = 256;
            prota.animations.add("walk", [0, 31, 62]);
            prota.animations.play("walk", 8, true);
            prota.anchor.setTo(0,1);

    //        game.add.sprite(100, 100,"bomp");
      //      var fire = game.add.sprite(200, 100, "fire");
        //    fire.animations.add("fire");
          //  fire.animations.play("fire", 50, true);

  //          var logo = game.add.sprite(game.world.centerX, game.world.centerY, 'logo');
    //        logo.anchor.setTo(0.5, 0.5);

            var layer = map.createLayer("Tile Layer 1");


            layer.resizeWorld();

            upKey = game.input.keyboard.addKey(Phaser.Keyboard.UP);
            downKey = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);
            leftKey = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
            rightKey = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
            spaceKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);

        }


        function update() {
          for(var i=0; i<bompstodelete.length; i++){
            bomp = bompstodelete[i];
            bomps.splice(bomps.indexOf(bomp), 1);
            bomp.destroy();
          }
          for(var i=0; i<firestodelete.length; i++){
            var fire = firestodelete[i];
            fires.splice(fires.indexOf(fire), 1);
            mapfires[fire.pos.x+(fire.pos.y-1)*20] = false;
            fire.destroy();
          }
          bompstodelete = [];
          firestodelete = [];
          if (upKey.isDown)
          {
              tryMove(prota_position.x, prota_position.y-1);
          }
          else if (downKey.isDown)
          {
            tryMove(prota_position.x, prota_position.y+1);
          }

          if (leftKey.isDown)
          {
            tryMove(prota_position.x-1, prota_position.y);
          }
          else if (rightKey.isDown)
          {
            tryMove(prota_position.x+1, prota_position.y);
          }
          else if(spaceKey.isDown) {
              var bump = game.add.sprite(prota.x, prota.y-128, "bomp");
              bump.timeLeft = 300;
              bump.pos = {x:prota_position.x, y:prota_position.y};
              bomps.push(bump);
          }

          for(var i=0; i<bomps.length; i++) {
            var bomp = bomps[i];
            bomp.timeLeft -= 1;
            if(bomp.timeLeft < 0) {
              function makeFire(x, y, dir){
                if (x >=0 && x<20 && y>=0 &&y <20 &&!mapfires[x+20*(y-1)] && map[x+(y-1)*20]=== 0) {
                    var fire = game.add.sprite(0,0, "fire");
                    var p = pospx({x:x, y:y});
                    fire.x = p.x, fire.y = p.y-128;
                    fire.pos = {x:x, y:y};
                    fire.animations.add("fire");
                    fire.animations.play("fire", 50, true);
                    fire.timeLeft = 000;
                    fire.alpha = 1;
                    fires.push(fire);
                    var tween = game.add.tween(fire);
                    tween.to({alpha:0}, 20000, Phaser.Easing.Exponential.In).onComplete.dispatch = function(){
                      firestodelete.push(fire);
                    };
                    tween.start();

                    mapfires[x+(y-1)*20] = fire;

                    switch(dir){
                      case 0: {
                        makeFire(x-1,y, 4);
                        makeFire(x,y+1, 3);
                        makeFire(x+1,y, 2);
                        makeFire(x,y-1, 1);
                      }; break;
                      case 1:
                        makeFire(x, y-1, 1);
                        break;
                      case 2:
                        makeFire(x+1,y, 2);
                        break;
                      case 3:
                        makeFire(x,y+1, 3);
                        break;
                      case 4:
                        makeFire(x-1,y, 4);
                        break;
                    }
                }

              }
              makeFire(bomp.pos.x, bomp.pos.y, 0);
              bompstodelete.push(bomp);
            }
          }

      }



        function pospx(pos){
          var px = {x:pos.x*128, y:pos.y*128};
          return px;

        }
        function tryMove(newPosx, newPosy) {
          if(!moving)
          if(map[newPosx+(newPosy-1)*20]===0){
            prota_position = {x:newPosx, y:newPosy};
            protaTween = game.add.tween(prota);
            protaTween.to(pospx(prota_position), 500);
            protaTween.start();
            protaTween.onComplete.dispatch = function(){moving=false;};
            moving = true;
          }
        }

        function render() {

        }

    };

    function generateTilemap(map) {
      var data = { "height":20,
       "layers":[
              {
               "data":map,
               "height":20,
               "name":"Tile Layer 1",
               "opacity":1,
               "type":"tilelayer",
               "visible":true,
               "width":20,
               "x":0,
               "y":0
              }],
       "orientation":"orthogonal",
       "properties":
          {

          },
       "tileheight":128,
       "tilesets":[
              {
               "firstgid":1,
               "image":"spritesheet_complete.png",
               "imageheight":2048,
               "imagewidth":4096,
               "margin":0,
               "name":"spritesheet_complete",
               "properties":
                  {

                  },
               "spacing":2,
               "tileheight":128,
               "tilewidth":128
              }],
       "tilewidth":128,
       "version":1,
       "width":20
     };
      return data;
    }

    </script>

    </body>
</html>
